{% extends 'common/base.html' %}
{% load static %}
{% load i18n %}

{% block extrahead %}
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
{% endblock %}

{% block content %}
<main class="min-h-screen p-4 flex flex-col items-center justify-center">
    <img class='w-full max-w-[1080px] absolute blur-sm -z-10 opacity-5' src={% static '/common/svg/logo/without_bg_icon_blue.svg'%} alt='logo do shortly'>
    <div class="flex flex-col w-full max-w-md justify-center gap-4">
        <div class="flex flex-col justify-center text-center">
            <h1 class="text-xl sm:text-2xl font-bold mb-2 text-center">{% trans "Link Shortener" %}</h1>
            <p class="text-sm md:text-base text-zinc-500 text-center">
                {% trans "Turn long links into short, shareable URLs" %}
            </p>
        </div>

        <div>
            <form method="post" class="border bg-white rounded-xl flex flex-col gap-3 p-4 border-zinc-200">
                {% if messages %}
                <div class="flex justify-center w-full">
                    <div class="w-full max-w-md">
                        {% for message in messages %}
                            <div class="rounded w-full">
                                {{ message|safe }}
                            </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                {% csrf_token %}

                <div class="flex flex-col gap-4">
                    <div class="flex flex-col flex-1 h-fit gap-4">
                        <label for="{{ form.original_url.id_for_label }}" class="block font-bold text-sm sm:text-md">
                            {% trans "Original URL" %}
                        </label>
                        {{ form.original_url }}
    
                        {% if form.original_url.errors %}
                            <p class="text-red-500 text-sm mt-1">{{ form.original_url.errors }}</p>
                        {% endif %}
                    </div>
                    
                    {% if request.user.is_authenticated %}
                    <div class="bg-zinc-100/60 rounded p-2 border border-zinc-200 flex gap-4">
                        
                        <div class="flex w-full justify-between items-center gap-3 p-4">
                            <span class="text-xs font-bold uppercase tracking-wider text-zinc-500">{% trans "Direct Link" %}</span>
                            <div class="flex w-fit h-fit">
                                <label class="relative inline-flex items-center cursor-pointer group">
                                    {{ form.is_direct }}
                                    <div class="w-11 h-6 bg-zinc-300 rounded-full peer peer-checked:bg-blue-600 transition-all duration-300"></div>
                                    <div class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-all duration-300 peer-checked:translate-x-5 shadow-sm"></div>
                                </label>
                            </div>
                        </div>

                        <div class="w-[1.5px] bg-zinc-200 h-100"></div>

                        <div class="flex w-full justify-between items-center gap-3 p-4">
                            <span class="text-xs font-bold uppercase tracking-wider text-zinc-500">{% trans "Permanent" %}</span>
                            <div class="flex w-fit h-fit">
                                <label class="relative inline-flex items-center cursor-pointer group">
                                    {{ form.is_permanent }}
                                    <div class="w-11 h-6 bg-zinc-300 rounded-full peer peer-checked:bg-blue-600 transition-all duration-300"></div>
                                    <div class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-all duration-300 peer-checked:translate-x-5 shadow-sm"></div>
                                </label>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <div id="cost-warning"
                    class="hidden text-sm text-center text-blue-500">
                </div>
                                
                <button type="submit" id="shorten_btn" class="btn w-full justify-center bg-blue-500 text-white hover:bg-blue-600 transition">
                    {% trans "Shorten" %}
                </button>
            </form>
        </div>
    </div>
</main>

{% include 'notification/includes/news_modal.html' %}
{% include 'converter/includes/url_already_exists_modal.html' %}

{% endblock %}

{% block scripts %}
<script src="{% static 'converter/js/utilities.js' %}"></script>
<script src="{% static 'converter/js/announcements.js' %}"></script>
<script id="pricing-data" type="application/json">
    {{ pricing|safe }}
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const pricing = JSON.parse(
        document.getElementById("pricing-data").textContent
    )

    const direct = document.getElementById("id_is_direct")
    const permanent = document.getElementById("id_is_permanent")
    const warning = document.getElementById("cost-warning")

    function sync() {
        let cost = pricing.base
        let labels = []

        if (direct?.checked) {
            cost += pricing.direct
            labels.push("{% trans 'direct' %}")
        }

        if (permanent?.checked) {
            cost += pricing.permanent
            labels.push("{% trans 'permanent' %}")
        }

        if (cost > pricing.base) {
            warning.innerText =
                `{% trans "This link will cost" %} ${cost} ` +
                `{% trans "coins" %} (${labels.join(" + ")})`
            warning.classList.remove("hidden")
        } else {
            warning.classList.add("hidden")
        }
    }

    direct?.addEventListener("change", sync)
    permanent?.addEventListener("change", sync)
    sync()
})
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const trigger = document.querySelector(".existing-url-trigger");
  if (!trigger) return;

  const modal = document.getElementById("existing-url-modal");
  const inputUrl = document.getElementById("modal-original-url");
  const inputDirect = document.getElementById("modal-is-direct");

  const mainCheckbox = document.getElementById("id_is_direct");

  inputUrl.value = trigger.dataset.originalUrl;

  const isDirect = trigger.dataset.isDirect === "true";

  if (mainCheckbox) {
      mainCheckbox.checked = isDirect;
      mainCheckbox.dispatchEvent(new Event("change"));
  }

  inputDirect.value = isDirect ? "true" : "false";

  modal.classList.remove("hidden");
  modal.classList.add("flex");

  document.getElementById("cancel-modal").onclick = () => modal.classList.add("hidden");
});
</script>
{% endblock %}